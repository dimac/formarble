"use strict";angular.module("formarble",[]).service("fm",function(){var e=/^\d+$/,t={oget:function(e,t){var n,r=t.split("."),o=e,i=r.length;for(n=0;i>n;n++)if(o=o[r[n]],void 0===o)return;return o},oset:function(t,n,r){var o,i,l=n.split("."),u=t;for(i=0;i<l.length-1;++i)o=l[i],void 0===u[o]&&(u[o]=e.test(l[i+1])?[]:{}),u=u[o];return u[l[i]]=r},odel:function(e,n){var r=n.split("."),o=r.pop(),i=r.join("."),l=t.oget(e,i);return l&&(l.splice?l.splice(o,1):delete l[o]),e},walkProps:function(e,n){angular.forEach(e.properties,function(e){n(e),t.walkProps(e,n)})},isEmpty:function(e){return void 0===e||null===e||angular.equals(e,{})||angular.equals(e,[])},urlResolver:function(e){return function(t){return t.controller("fmForm").getTemplateUrl(e)}}};return t}).directive("fmForm",["$compile","fm",function(e,t){return{restrict:"EA",require:"fmForm",scope:{$control:"=fmForm",$model:"=fmModel"},terminal:!0,controllerAs:"$form",controller:["$scope","$attrs",function(e,n){if(angular.isUndefined(e.$model))throw new Error("Looks like fmModel attribute is not set or model is undefined yet");this.hasValue=function(n){return void 0!==t.oget(e.$model,n._path||n)},this.getValue=function(n){return t.oget(e.$model,n._path||n)},this.setValue=function(n,r){return t.oset(e.$model,n._path||n,r)},this.delValue=function(n){return t.odel(e.$model,n._path||n)},this.getTemplateUrl=function(e){return(n.fmTheme||"default")+"/"+e+".html"},this.getControlModel=function(e){return["$model",e._path].join(".")},this.getControlId=function(e){return e._path&&e._path.split(".").join("-")},this.hasChildren=function(e){return void 0!==e.properties},this.getChildren=function(e){return angular.isObject(e.properties)?Object.keys(e.properties).map(function(t){return e.properties[t]}).sort(function(e,t){return angular.isDefined(e.order)&&angular.isDefined(t.order)?e.order-t.order:angular.isDefined(e.order)?-1:angular.isDefined(t.order)?1:e._order-t._order}):void 0}}],link:function(t,n){n.find("[fm-control]").length||n.append("<div fm-control></div>"),e(n.contents())(t)}}}]).directive("fmControl",["$compile","$injector","fm",function(e,t){var n="Directive";return{require:"^fmForm",terminal:!0,link:function(r,o,i,l){var u,a,f=i.fmControl||"$control";r.$watch(f,function(f){if(u&&u.$destroy(),a&&i.$set(a,null),o.html(""),f){if(!f.display)return void console.warn("fmControl","Display options not defined",f);var s,d=i.$normalize(f.display.name);if(!t.has(d+n))return void console.warn("fmControl","No directive",d,"defined",f);u=s=r.$new(),a=d,i.$set("fmControl",null),i.$set("ngRepeat",null),i.$set(d,""),f.$id=l.getControlId(f),f.$model=l.getControlModel(f),s.$control=f,s.$subControls=l.getChildren(f),l.hasChildren(f)||(s.$useDefault=!l.hasValue(f),s.$setRecommended=function(){angular.isDefined(f.recommend)&&l.setValue(f,f.recommend),s.$useDefault=!1},s.$setEmpty=function(){l.delValue(f),s.$useDefault=!0},r.$watch(f.$model,function(e){f.$value=s.$value=e,f.$empty=s.$empty=void 0===e||null===e})),o.data("$control",f),e(o)(s)}})}}}]).directive("fmControlLabel",["fm",function(e){return{templateUrl:e.urlResolver("control-label"),link:function(e,t,n){var r=e.$eval(n.fmControlLabel||"$control");void 0===n.for&&n.$set("for",r.$id)}}}]).directive("fmControlEmpty",["fm",function(e){return{priority:600,templateUrl:e.urlResolver("control-empty")}}]).directive("fmControlInput",["$compile","fm",function(e){function t(e){return"ng"+e.charAt(0).toUpperCase()+e.slice(1)}var n=["pattern","minlength","maxlength","required"],r=["min","max","step"];return{require:"^fmForm",priority:200,terminal:!0,compile:function(o,i){var l=o.prop("tagName"),u="SELECT"===l,a="INPUT"===l||"TEXTAREA"===l,f=i.fmControlInput||"$control";return i.$set("fmControlInput",null),function(o,i,l){var s=o.$eval(f);l.$set("ngModel",s.$model),l.$set("id",s.$id),a&&(l.type||l.$set("type",s.display.type),n.forEach(function(e){var n=s.display[e];angular.isDefined(n)&&l.$set(t(e),n)}),r.forEach(function(e){var t=s.display[e];angular.isDefined(t)&&l.$set(e,t)})),u&&l.$set("ngOptions","o.id as o.title for o in "+f+".display.options"),e(i)(o),o.$input=i.controller("ngModel")}}}}]).directive("fmReset",function(){return{require:"^form",link:function(e,t,n,r){function o(t){n.ngClick||t.preventDefault(),e.$apply(e.$control.$model+" = undefined"),r.$setPristine()}t.bind("click",o),e.$on("destroy",function(){t.unbind("click",o)})}}});